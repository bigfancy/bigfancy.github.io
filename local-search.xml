<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>load-test1</title>
    <link href="/2025/05/26/load-test1/"/>
    <url>/2025/05/26/load-test1/</url>
    
    <content type="html"><![CDATA[<h1 id="sauce-labs-と-aws">Sauce Labs と AWS</h1><hr><h2 id="sauce-labs-と-aws-自前環境の比較playwright-実行">🧪 Sauce Labsと AWS 自前環境の比較（Playwright 実行）</h2><table><thead><tr><th>比較項目</th><th>Sauce Labs</th><th>AWS 自前構築</th></tr></thead><tbody><tr><td>🛠️ 設定の難易度</td><td>✅ すぐに使える、ほぼ設定不要</td><td>❌ OS、Node、ブラウザ、Playwright、CI/CD など手動設定必要</td></tr><tr><td>📦 Playwright 対応</td><td>✅ Playwright 対応済み、複数ブラウザ/バージョン選択可</td><td>❌ 自分でインストール・管理する必要</td></tr><tr><td>🌐 OS / ブラウザの種類</td><td>✅ macOS、Windows、Linux、Android、iOS に対応</td><td>⛔ AWS では iOS/macOS は非対応（macOS は EC2 Mac 限定）</td></tr><tr><td>📊 並列実行</td><td>✅ プランに応じて複数のテストを並列実行可能</td><td>⛔ 並列化は自力で構築（例：Docker, EC2 Auto Scaling）</td></tr><tr><td>📈 可視化 / レポート</td><td>✅ テストログ、動画、スクリーンショット、ネットワーク記録あり</td><td>❌ 自分で Allure や Playwright Trace Viewer を統合必要</td></tr><tr><td>🧪 CI/CD 連携</td><td>✅ GitHub Actions, Jenkins, GitLab 等と簡単連携</td><td>✅ 柔軟だが設定は自分で行う必要あり</td></tr><tr><td>💸 コスト</td><td>💰 利用時間・並列数で課金。小規模チームにはやや高額かも</td><td>💰 EC2（特にSpot）なら安価。ただし保守負担あり</td></tr><tr><td>🔒 セキュリティ</td><td>✅ ISO, SOC2などの企業向け認証を取得</td><td>設定次第（例：VPC, IAM, セキュリティグループ）</td></tr></tbody></table><hr><h2 id="おすすめの選び方">🎯 おすすめの選び方</h2><table><thead><tr><th>利用ケース</th><th>推奨環境</th></tr></thead><tbody><tr><td>すぐに使える環境が欲しい、テストロジックに集中したい</td><td>✅ Sauce Labs</td></tr><tr><td>DevOps チームあり、コストを抑えたい場合</td><td>✅ AWS 自前構築</td></tr><tr><td>macOS / Safari / iOS のテストが必要な場合</td><td>✅ Sauce Labs（または AWS EC2 Mac）</td></tr><tr><td>テスト記録や可視化レポートが欲しい場合</td><td>✅ Sauce Labs</td></tr><tr><td>テスト頻度が少ない、小規模検証用</td><td>AWS + ローカル or コンテナ構築で十分</td></tr></tbody></table><hr><p>必要であれば、以下の資料もご提供可能です：</p><ul><li>AWS 上で Playwright 実行環境を構築する Dockerfile + CI 設定例</li><li>Sauce Labs 上で Playwright を使う <code>.yml</code> 設定例</li><li>コスト比較の目安</li></ul><p>詳しく知りたい項目があれば、お知らせください。</p><p>SauceLabsで300並列セッション（同時実行数）を利用する場合、<strong>Enterpriseプラン</strong>が必要となります。</p><hr><h3 id="enterpriseプランの概要">💰 Enterpriseプランの概要</h3><p>Sauce Labsの公式サイトでは、標準プラン（Live Testing、VirtualCloud、Real DeviceCloud）は最大24並列セッションまでの対応となっており、それ以上の並列数を希望する場合はEnterpriseプランの契約が必要です。([saucelabs.com][1])</p><p>Enterpriseプランの主な特徴：</p><ul><li><strong>300以上の並列セッション</strong>に対応</li><li><strong>無制限の自動テスト実行時間</strong></li><li><strong>専用のサポート体制</strong>（プレミアムサポート、技術ワークショップなど）</li><li><strong>SSO（シングルサインオン）対応</strong></li><li><strong>プライベートデバイスクラウドの利用</strong></li><li><strong>チーム管理機能</strong></li><li><strong>エンタープライズグレードのセキュリティ</strong></li></ul><p>具体的な料金については、公式サイトには記載がなく、<strong>カスタム見積もり</strong>となります。</p><hr><h3 id="見積もりの取得方法">📞 見積もりの取得方法</h3><p>300並列セッションの利用を検討されている場合、SauceLabsの営業チームに直接お問い合わせいただくことをおすすめします。</p><ul><li><p><strong>お問い合わせフォーム</strong>： <a href="https://saucelabs.com/contact">https://saucelabs.com/contact</a>([BusinessInsider][2])</p></li><li><p><strong>デモのリクエスト</strong>： <a href="https://saucelabs.com/demo">https://saucelabs.com/demo</a>([G2][3])</p></li></ul><p>これらのページから、必要な並列数や利用目的、チーム規模などの情報を提供することで、最適なプランと料金の提案を受けることができます。</p><hr><h3 id="補足情報">📝 補足情報</h3><ul><li><p>G2のユーザーレビューによると、SauceLabsを利用して<strong>110のインスタンスを同時に起動</strong>し、300のテストケースを10分以内に実行した事例があります。([G2][3])</p></li><li><p>このように、SauceLabsのEnterpriseプランを活用することで、大規模な並列テストの実行が可能となります。</p></li></ul><hr><h1 id="docker-compose-playwright">Docker Compose + Playwright</h1><p>以下是一个使用 <strong>Docker Compose + Playwright</strong> 实现<strong>300 并发访问</strong> 的基本示例方案。这个方案利用多个 Docker容器并行运行 Playwright 脚本，每个容器执行一部分任务，总体达到 300并发访问的目的。</p><hr><h2 id="目标">✅ 目标</h2><ul><li>每个容器执行 10 并发 context</li><li>启动 30 个容器 → 总共 300 并发请求</li></ul><hr><h2 id="项目结构">📁 项目结构</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">playwright-loadtest/<br>├── docker-compose<span class="hljs-selector-class">.yml</span><br>├── Dockerfile<br>├── package<span class="hljs-selector-class">.json</span><br>├── loadtest.js<br></code></pre></td></tr></table></figure><hr><h2 id="dockerfile">🐳 Dockerfile</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">FROM</span> mcr.microsoft.com/playwright:v1.<span class="hljs-number">43.1</span>-jammy<br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> npm install</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;node&quot;</span>, <span class="hljs-string">&quot;loadtest.js&quot;</span>]</span><br></code></pre></td></tr></table></figure><hr><h2 id="package.json">📦 package.json</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;playwright-loadtest&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;start&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node loadtest.js&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;playwright&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^1.43.1&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><hr><h2 id="loadtest.js1容器执行10并发">🧪loadtest.js（1容器执行10并发）</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; chromium &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;playwright&#x27;</span>);<br><br>(<span class="hljs-title function_">async</span> () =&gt; &#123;<br>  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> chromium.<span class="hljs-title function_">launch</span>(&#123; <span class="hljs-attr">headless</span>: <span class="hljs-literal">true</span> &#125;);<br>  <span class="hljs-keyword">const</span> tasks = [];<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    tasks.<span class="hljs-title function_">push</span>((<span class="hljs-title function_">async</span> () =&gt; &#123;<br>      <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newContext</span>();<br>      <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">newPage</span>();<br>      <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">&#x27;https://example.com&#x27;</span>);<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Done: <span class="hljs-subst">$&#123;i&#125;</span>`</span>);<br>      <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">close</span>();<br>    &#125;)());<br>  &#125;<br><br>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks);<br>  <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">close</span>();<br>&#125;)();<br></code></pre></td></tr></table></figure><hr><h2 id="docker-compose.yml30-容器启动">🧬 docker-compose.yml（30容器启动）</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">playwright:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span><br>    <span class="hljs-attr">deploy:</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">30</span>  <span class="hljs-comment"># 🚀 启动 30 个容器 x 每容器10并发 = 300并发</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">&quot;no&quot;</span><br></code></pre></td></tr></table></figure><blockquote><p>⚠️ 注意：需要 <code>docker compose up --scale playwright=30</code>或使用 <code>deploy.replicas</code>（需要 swarm mode）</p></blockquote><hr><h2 id="启动命令">🚀 启动命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 构建镜像</span><br>docker compose build<br><br><span class="hljs-comment"># 启动 30 个实例</span><br>docker compose up --scale playwright=30<br></code></pre></td></tr></table></figure><hr><h2 id="注意事项">✅ 注意事项</h2><table><thead><tr><th>注意点</th><th>内容</th></tr></thead><tbody><tr><td><strong>系统资源</strong></td><td>每个容器需要约 0.5～1GB 内存，需确保至少 16～32GB RAM</td></tr><tr><td><strong>目标网站限制</strong></td><td>不要对生产环境发起300并发测试，请使用允许压测的URL</td></tr><tr><td><strong>Docker 限制</strong></td><td>并发过高可能触发 Docker NAT or network 带宽限制</td></tr><tr><td><strong>拡張性</strong></td><td>可替换为 Kubernetes + HPA 实现更高级调度</td></tr></tbody></table><hr><h2 id="拓展建议">📦 拓展建议</h2><ul><li>使用环境变量配置每个容器的任务数</li><li>将请求结果写入 Redis/PostgreSQL 等用于后续分析</li><li>集成 Grafana + Prometheus 监控运行情况</li></ul><hr><h1 id="docker-compose-playwright2">Docker Compose + Playwright2</h1><p>以下是一个<strong>只用 <code>docker-compose.yml</code> 来登录Salesforce 并执行 Playwright 并发访问（含 Cookie重用）的完整实现方案</strong>，不需要你手动执行<code>docker build</code> 或 <code>docker run</code> 命令。</p><hr><h2 id="方案概述一次性执行-login-并发访问">✅ 方案概述（一次性执行 login+ 并发访问）</h2><p>我们将构建两个服务：</p><ol type="1"><li><strong>login</strong>：执行 Salesforce 登录并保存 cookie</li><li><strong>parallel</strong>：读取 cookie 并发起 10 并发请求</li></ol><p>并通过 <code>depends_on</code> 确保 login 在并发访问之前完成。</p><hr><h2 id="项目结构-1">📁 项目结构</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">salesforce-playwright/<br>├── docker-compose<span class="hljs-selector-class">.yml</span><br>├── Dockerfile<br>├── login<span class="hljs-selector-class">.js</span><br>├── parallelAccess<span class="hljs-selector-class">.js</span><br>├── package.json<br></code></pre></td></tr></table></figure><hr><h2 id="docker-compose.yml核心">🐳 docker-compose.yml（核心）</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.8&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">login:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">node</span> <span class="hljs-string">login.js</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">.:/app</span><br>    <span class="hljs-comment"># cookie 存储用</span><br>    <span class="hljs-attr">working_dir:</span> <span class="hljs-string">/app</span><br><br>  <span class="hljs-attr">parallel:</span><br>    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">node</span> <span class="hljs-string">parallelAccess.js</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">.:/app</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">login</span><br>    <span class="hljs-attr">working_dir:</span> <span class="hljs-string">/app</span><br></code></pre></td></tr></table></figure><hr><h2 id="dockerfile共通">🐳 Dockerfile（共通）</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">FROM</span> mcr.microsoft.com/playwright:v1.<span class="hljs-number">43.1</span>-jammy<br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> . .</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> npm install</span><br></code></pre></td></tr></table></figure><hr><h2 id="login.js首次登录并保存-cookie">🧠 login.js（首次登录并保存cookie）</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; chromium &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;playwright&#x27;</span>);<br><br>(<span class="hljs-title function_">async</span> () =&gt; &#123;<br>  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> chromium.<span class="hljs-title function_">launch</span>(&#123; <span class="hljs-attr">headless</span>: <span class="hljs-literal">true</span> &#125;);<br>  <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newContext</span>();<br>  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">newPage</span>();<br><br>  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">&#x27;https://login.salesforce.com&#x27;</span>);<br>  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">fill</span>(<span class="hljs-string">&#x27;input#username&#x27;</span>, process.<span class="hljs-property">env</span>.<span class="hljs-property">SF_USERNAME</span> || <span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">fill</span>(<span class="hljs-string">&#x27;input#password&#x27;</span>, process.<span class="hljs-property">env</span>.<span class="hljs-property">SF_PASSWORD</span> || <span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<br>    page.<span class="hljs-title function_">waitForNavigation</span>(),<br>    page.<span class="hljs-title function_">click</span>(<span class="hljs-string">&#x27;input#Login&#x27;</span>),<br>  ]);<br><br>  <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">storageState</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;sf-auth.json&#x27;</span> &#125;);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;✅ Logged in and saved auth&#x27;</span>);<br>  <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">close</span>();<br>&#125;)();<br></code></pre></td></tr></table></figure><hr><h2 id="parallelaccess.js并发访问">⚡ parallelAccess.js（并发访问）</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; chromium &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;playwright&#x27;</span>);<br><br>(<span class="hljs-title function_">async</span> () =&gt; &#123;<br>  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> chromium.<span class="hljs-title function_">launch</span>(&#123; <span class="hljs-attr">headless</span>: <span class="hljs-literal">true</span> &#125;);<br>  <span class="hljs-keyword">const</span> tasks = [];<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    tasks.<span class="hljs-title function_">push</span>((<span class="hljs-title function_">async</span> () =&gt; &#123;<br>      <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newContext</span>(&#123; <span class="hljs-attr">storageState</span>: <span class="hljs-string">&#x27;sf-auth.json&#x27;</span> &#125;);<br>      <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">newPage</span>();<br>      <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">&#x27;https://your-domain.my.site.com/target-page&#x27;</span>);<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ Accessed <span class="hljs-subst">$&#123;i + <span class="hljs-number">1</span>&#125;</span>: <span class="hljs-subst">$&#123;<span class="hljs-keyword">await</span> page.title()&#125;</span>`</span>);<br>      <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">close</span>();<br>    &#125;)());<br>  &#125;<br><br>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks);<br>  <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">close</span>();<br>&#125;)();<br></code></pre></td></tr></table></figure><hr><h2 id="package.json依赖定义">📦 package.json（依赖定义）</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;salesforce-playwright&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;playwright&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^1.43.1&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><hr><h2 id="一键执行命令">🚀 一键执行命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker compose up --build<br></code></pre></td></tr></table></figure><p>这将顺序执行：</p><ol type="1"><li>login 服务（保存 Cookie）</li><li>parallel 服务（读取 Cookie 并发访问）</li></ol><hr><h2 id="环境变量可选">🧪 环境变量（可选）</h2><p>你也可以将 <code>SF_USERNAME</code> 和 <code>SF_PASSWORD</code> 写入<code>.env</code> 文件，Compose 会自动加载：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">SF_USERNAME</span>=your-username@example.com<br><span class="hljs-attr">SF_PASSWORD</span>=your-password<br></code></pre></td></tr></table></figure><p>然后在 login.js 中使用 <code>process.env.SF_USERNAME</code></p><hr><h2 id="整体优势">✅ 整体优势</h2><table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>簡単性</td><td>只需 <code>docker compose up --build</code> 一条命令</td></tr><tr><td>再利用性</td><td>Cookie 保存在容器 volume 中，可重复使用</td></tr><tr><td>可扩展性</td><td>并发数可调，适合加大到 100 或 300</td></tr><tr><td>CI/CD対応</td><td>可嵌入 GitHub Actions、GitLab CI 等</td></tr></tbody></table><hr><p>如果你需要这个完整项目作为 <code>.zip</code> 文件或者 GitHub模板，我可以立即帮你生成。是否需要？</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>load-test</title>
    <link href="/2025/04/21/load-test/"/>
    <url>/2025/04/21/load-test/</url>
    
    <content type="html"><![CDATA[<h2 id="目的">✅ 目的</h2><ul><li><p>Sauce Labs 上で Playwright テストを <strong>300並行実行</strong></p></li><li><p>各アクセスに対して：</p><ul><li><code>browser.newContext()</code> を使い独立セッション作成</li><li><code>page.goto()</code> にかかる時間（反応時間）を計測</li></ul></li><li><p>結果をログ or ファイルに保存（CSVやJSON）</p></li></ul><hr><h2 id="前提条件">✅ 前提条件</h2><ol type="1"><li><strong>Sauce Labs アカウント</strong></li><li>Playwright のプロジェクト構成</li><li>Node.js 環境</li></ol><hr><h2 id="sauce-labs-playwright-の基本構成setup">✅ Sauce Labs +Playwright の基本構成（setup）</h2><p>まず、<code>sauce.config.js</code> を作成して、Sauce Labs にPlaywright テストを接続します。</p><h3 id="step-1-install-必要パッケージ">🔧 Step 1: Install必要パッケージ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install --save-dev @saucelabs/playwright-runner playwright<br></code></pre></td></tr></table></figure><h3 id="プロジェクト構成例">📁 プロジェクト構成例</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">project/<br>├── sauce<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span><br>├── tests/<br>│   └── load<span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.js</span><br>├── results/<br>│   └── result.csv<br></code></pre></td></tr></table></figure><hr><h2 id="step-2-sauce.config.js-設定例">✅ Step 2: sauce.config.js設定例</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">runner</span>: <span class="hljs-string">&#x27;playwright&#x27;</span>,<br>  <span class="hljs-attr">region</span>: <span class="hljs-string">&#x27;us-west-1&#x27;</span>, <span class="hljs-comment">// または eu-central-1</span><br>  <span class="hljs-attr">sauce</span>: &#123;<br>    <span class="hljs-attr">username</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">SAUCE_USERNAME</span>,<br>    <span class="hljs-attr">accessKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">SAUCE_ACCESS_KEY</span>,<br>    <span class="hljs-attr">metadata</span>: &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Playwright Load Test&#x27;</span>,<br>      <span class="hljs-attr">build</span>: <span class="hljs-string">&#x27;300-context-test&#x27;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">playwright</span>: &#123;<br>    <span class="hljs-attr">version</span>: <span class="hljs-string">&#x27;1.43.1&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">suites</span>: [<br>    &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;300-concurrent-access&#x27;</span>,<br>      <span class="hljs-attr">src</span>: [<span class="hljs-string">&#x27;./tests/load.test.js&#x27;</span>],<br>      <span class="hljs-attr">platformName</span>: <span class="hljs-string">&#x27;Windows 11&#x27;</span>,<br>      <span class="hljs-attr">browserName</span>: <span class="hljs-string">&#x27;chrome&#x27;</span>,<br>      <span class="hljs-attr">browserVersion</span>: <span class="hljs-string">&#x27;latest&#x27;</span><br>    &#125;<br>  ]<br>&#125;;<br></code></pre></td></tr></table></figure><hr><h2 id="step-3-playwright-テストで-300-並行アクセスload.test.js">✅ Step3: Playwright テストで 300並行アクセス（<code>load.test.js</code>）</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> &#123; test &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@playwright/test&#x27;</span>);<br><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;Run 300 parallel context accesses&#x27;</span>, <span class="hljs-title function_">async</span> (&#123; browser &#125;) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONCURRENCY</span> = <span class="hljs-number">300</span>;<br>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TARGET_URL</span> = <span class="hljs-string">&#x27;https://example.com&#x27;</span>; <span class="hljs-comment">// ← テスト対象URL</span><br>  <span class="hljs-keyword">const</span> results = [];<br><br>  <span class="hljs-comment">// context 単位で同時実行</span><br>  <span class="hljs-keyword">const</span> tasks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(&#123; <span class="hljs-attr">length</span>: <span class="hljs-variable constant_">CONCURRENCY</span> &#125;, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> (<span class="hljs-title function_">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newContext</span>();<br>    <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">newPage</span>();<br><br>    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>    <span class="hljs-keyword">let</span> duration = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">let</span> error = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-variable constant_">TARGET_URL</span>, &#123; <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span> &#125;);<br>      duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`User <span class="hljs-subst">$&#123;i + <span class="hljs-number">1</span>&#125;</span> finished in <span class="hljs-subst">$&#123;duration&#125;</span> ms`</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>      error = err.<span class="hljs-property">message</span>;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`User <span class="hljs-subst">$&#123;i + <span class="hljs-number">1</span>&#125;</span> failed: <span class="hljs-subst">$&#123;error&#125;</span>`</span>);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      results.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">id</span>: i + <span class="hljs-number">1</span>, duration, error &#125;);<br>      <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">close</span>();<br>    &#125;<br>  &#125;)());<br><br>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks);<br><br>  <span class="hljs-comment">// 保存 CSV</span><br>  <span class="hljs-keyword">const</span> csv = [<br>    <span class="hljs-string">&#x27;id,duration_ms,error&#x27;</span>,<br>    ...results.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;r.id&#125;</span>,<span class="hljs-subst">$&#123;r.duration ?? <span class="hljs-string">&#x27;&#x27;</span>&#125;</span>,&quot;<span class="hljs-subst">$&#123;r.error ?? <span class="hljs-string">&#x27;&#x27;</span>&#125;</span>&quot;`</span>)<br>  ].<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>  fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">&#x27;./results/result.csv&#x27;</span>, csv);<br>&#125;);<br></code></pre></td></tr></table></figure><hr><h2 id="step-4-テスト実行">✅ Step 4: テスト実行</h2><p>環境変数で Sauce Labs の認証情報を指定して実行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> SAUCE_USERNAME=your-username<br><span class="hljs-built_in">export</span> SAUCE_ACCESS_KEY=your-access-key<br><br>npx saucectl run<br></code></pre></td></tr></table></figure><p>※ Windows の場合は <code>set</code> コマンドで環境変数を設定</p><hr><h2 id="補足並列数のコントロールについて">✅補足：並列数のコントロールについて</h2><p>Sauce Labs の <strong>並列セッション数（concurrency limit）</strong>に依存します。</p><ul><li>無料プラン・Basic：1〜2 並列</li><li>チーム／Enterprise：20〜200 並列可能（契約次第）</li></ul><p>🎯 <strong>300並行アクセスを本番環境で一度に走らせたい場合、Enterprise契約や並列数制御ロジック（例：batch 実行）が必要です。</strong></p><hr><h2 id="バッチ的に300並行を再現代替案">✅バッチ的に300並行を再現（代替案）</h2><p>300を一気に実行できない場合：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BATCH_SIZE</span> = <span class="hljs-number">50</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BATCH_COUNT</span> = <span class="hljs-number">6</span>;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">BATCH_COUNT</span>; i++) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Starting batch <span class="hljs-subst">$&#123;i + <span class="hljs-number">1</span>&#125;</span>`</span>);<br>  <span class="hljs-keyword">const</span> tasks = [];<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-variable constant_">BATCH_SIZE</span>; j++) &#123;<br>    tasks.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">runContextAccess</span>(i * <span class="hljs-variable constant_">BATCH_SIZE</span> + j + <span class="hljs-number">1</span>));<br>  &#125;<br>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="結果分析">✅ 結果分析</h2><ul><li>CSV 出力結果を Excel や pandas で分析</li><li>ヒストグラムや平均・中央値を出せば、レスポンスタイムの偏りを可視化できます</li></ul><hr><h2 id="まとめ">✅ まとめ</h2><table><thead><tr><th>項目</th><th>実現方法</th></tr></thead><tbody><tr><td>300 並行</td><td><code>Promise.all</code> + <code>browser.newContext()</code></td></tr><tr><td>クラウド実行</td><td>Sauce Labs の <code>saucectl</code> で実行</td></tr><tr><td>応答時間計測</td><td><code>Date.now()</code> で <code>page.goto()</code>の前後を記録</td></tr><tr><td>結果保存</td><td>CSV形式でファイル出力 or ログ表示</td></tr><tr><td>並列制限対策</td><td>分割実行（50並列 × 6バッチ）またはプランアップグレード</td></tr></tbody></table><p>画面反応時間に関わる主な要素（5カテゴリ）</p><ol type="1"><li>ネットワーク（DNS, SSL, TTFB）</li><li>サーバー処理（Apex, SOQL, API連携）</li><li>フロントエンド（レンダリング, JS実行, リソース読み込み）</li><li>UI構成（LWCの描画数・ロジック）</li><li>外部条件（キャッシュ, セッション, ユーザー状態）</li></ol><p>以下に、Salesforce（特にExperienceCloudやLWCを多用したポータル）の実環境において「<strong>画面反応時間に影響する上位5要素</strong>」を<strong>影響度が高い順に</strong>ランキング形式で解説します。</p><hr><h2 id="画面反応時間に影響する上位5要素">🏆画面反応時間に影響する上位5要素</h2><h3 id="位apex処理サーバー処理">🥇1位：<strong>Apex処理（サーバー処理）</strong></h3><ul><li>複雑なロジックや大規模なSOQL、外部API連携がある場合、<strong>最も時間がかかる傾向</strong>があります。</li><li>特に <code>@wire</code>による呼び出しが多い画面では、サーバー処理が終わるまでUIが描画されません。</li><li><strong>遅い例</strong>：多階層の集計SOQL、ループ内SOQL、外部API呼び出し付きのApex</li></ul><hr><h3 id="位リソース読み込み画像cssjs">🥈2位：<strong>リソース読み込み（画像・CSS・JS）</strong></h3><ul><li>Salesforceポータルはテーマやテンプレートに多くの静的リソースが含まれます。</li><li>特に画像サイズが大きい／圧縮されていない／CDNキャッシュが外れると<strong>LCP（LargestContentful Paint）に悪影響</strong>を与えます。</li><li><strong>遅い例</strong>：ヒーローバナー、スライダー、動的読み込みのアイコン画像群</li></ul><hr><h3 id="位javascript実行クライアント処理">🥉3位：<strong>JavaScript実行（クライアント処理）</strong></h3><ul><li>LWCコンポーネントはクライアントでのJS初期化が多く、<strong>DOM描画前にJSの依存関係が処理される</strong></li><li>特に動的な描画（条件付き、for:eachなど）や、Apex応答に応じてUIを構築するタイプのコードでは影響が大きい</li><li><strong>遅い例</strong>：多段階条件分岐、複雑な JSONパースと描画</li></ul><hr><h3 id="位soqlクエリの性能サーバー処理の一部">🏅4位：<strong>SOQLクエリの性能（サーバー処理の一部）</strong></h3><ul><li>Apexの中でも特にSOQLクエリがボトルネックになりやすい。</li><li>結果件数が多い、非選択リスト項目に対するフィルタ、インデックスなしのフィールド検索などは<strong>明確に遅くなる</strong></li><li><strong>遅い例</strong>：複数の関連オブジェクトをJOINするようなクエリ</li></ul><hr><h3 id="位lwcの描画数ロジックui構成">🎖5位：<strong>LWCの描画数・ロジック（UI構成）</strong></h3><ul><li>表示時に描画されるLWC数が多いと、それぞれのライフサイクルフック(<code>connectedCallback</code>, <code>renderedCallback</code>)が走る</li><li>特に複雑な条件表示や for:eachで大量のデータを表示する画面は描画遅延に直結する</li><li><strong>遅い例</strong>：100件のレコードをリスト表示し、さらに各レコードにボタン/サブコンポーネントを持つ場合</li></ul><hr><h2 id="想定外だったけどあまり重くない要素">⛳想定外だったけどあまり重くない要素</h2><table><thead><tr><th>要素</th><th>備考</th></tr></thead><tbody><tr><td>DNS / SSL</td><td>一度確立すれば基本的にキャッシュされる。初回アクセスを除き無視できる程度</td></tr><tr><td>キャッシュ</td><td>CDNが有効であればむしろ描画を高速化する</td></tr><tr><td>セッション確立</td><td>通常はSalesforceが高速に処理してくれる。ただし大量同時ログインは注意</td></tr><tr><td>TTFB</td><td>ApexやSOQLが速ければ自動的に短くなる傾向があるため、間接的な指標</td></tr></tbody></table><hr><h2 id="まとめ上位5ランキング">✅ まとめ：上位5ランキング</h2><table><thead><tr><th>順位</th><th>要素</th><th>カテゴリ</th></tr></thead><tbody><tr><td>🥇1位</td><td>Apex処理の遅延</td><td>サーバー処理</td></tr><tr><td>🥈2位</td><td>リソース（画像・CSS）の読込遅延</td><td>フロントエンド</td></tr><tr><td>🥉3位</td><td>JS実行負荷</td><td>フロントエンド</td></tr><tr><td>🏅4位</td><td>SOQLクエリの最適化不足</td><td>サーバー処理</td></tr><tr><td>🎖5位</td><td>LWCの描画数や条件ロジック</td><td>UI構成</td></tr></tbody></table>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>BlockChain基础一</title>
    <link href="/2025/02/09/BlockChain-Basic1/"/>
    <url>/2025/02/09/BlockChain-Basic1/</url>
    
    <content type="html"><![CDATA[<h1>签名</h1><h2 id="签名的流程">签名的流程</h2><pre><code class=" mermaid">sequenceDiagram    participant User as 用户    participant Wallet as Web3钱包    participant HashFunc as Keccak-256 哈希    participant ECDSA as ECDSA 签名    participant Blockchain as 区块链(可选)    Note right of User: 1. 发起交易或消息    User-&gt;&gt;Wallet: 交易/消息数据    Wallet-&gt;&gt;HashFunc: 计算 Keccak-256 哈希    HashFunc--&gt;&gt;Wallet: messageHash    Note right of Wallet: 2. 使用私钥进行 ECDSA 签名    Wallet-&gt;&gt;ECDSA: 使用私钥签名 messageHash    ECDSA--&gt;&gt;Wallet: 生成签名 (r, s, v)    Note right of Wallet: 3. 返回签名数据    Wallet--&gt;&gt;User: (r, s, v)    alt 交易签名        User-&gt;&gt;Blockchain: 广播已签名交易        Blockchain--&gt;&gt;User: 交易确认    else 消息签名        User-&gt;&gt;DApp: 发送签名        DApp-&gt;&gt;Wallet: 使用公钥验证签名        Wallet--&gt;&gt;DApp: 验证成功    end    Note right of User: 🎉 签名完成！</code></pre><h3 id="私钥签名的具体过程"><strong>私钥签名的具体过程</strong></h3><p>私钥签名的核心在于使用 <strong>椭圆曲线数字签名算法（ECDSA）</strong> 生成唯一的数字签名，确保数据的完整性和身份认证。在以太坊和 Web3 生态中，签名主要用于：</p><ul><li><strong>交易签名（Transaction Signing）</strong></li><li><strong>消息签名（Message Signing）</strong></li></ul><p>以下是 <strong>私钥签名的完整技术细节</strong>，包括数学原理和代码示例。</p><hr><h2 id="1-私钥签名的数学原理"><strong>1. 私钥签名的数学原理</strong></h2><p>在以太坊中，私钥签名使用 <strong>椭圆曲线 SECP256k1</strong> 和 <strong>Keccak-256 哈希算法</strong>。完整流程如下：</p><h3 id="🔹-1-1-生成哈希值"><strong>🔹 1.1 生成哈希值</strong></h3><ul><li>交易或消息数据会先进行 <strong>Keccak-256 哈希计算</strong>，得到 <code>messageHash</code>。</li></ul><h3 id="🔹-1-2-生成签名"><strong>🔹 1.2 生成签名</strong></h3><p>使用 <strong>私钥 ( k )</strong> 进行 ECDSA 签名，计算出 <code>(r, s, v)</code>：</p><ol><li><strong>随机选择一个数 ( k_e )</strong>（必须是安全的随机数）。</li><li><strong>计算曲线点 ( P = k_e \cdot G )</strong><ul><li>其中 <code>G</code> 是椭圆曲线的基点。</li><li><code>r</code> 是 <code>P</code> 点的 <code>x</code> 坐标。</li></ul></li><li><strong>计算签名参数 ( s )</strong><ul><li>( s = k_e^{-1} \cdot (messageHash + r \cdot k) \mod n )</li><li>其中 ( n ) 是曲线的阶，( k ) 是私钥。</li></ul></li><li><strong>计算恢复参数 ( v )</strong><ul><li>( v ) 是一个额外的参数，用于从签名恢复公钥（取值 <code>0</code> 或 <code>1</code>）。</li></ul></li></ol><p>最终，签名由 <strong>(r, s, v)</strong> 三个值组成。</p><h3 id="🔹-1-3-验证签名"><strong>🔹 1.3 验证签名</strong></h3><ol><li>使用公钥和 <code>r, s, v</code> 计算恢复出的 <code>messageHash</code>。</li><li>若恢复出的哈希值与原始 <code>messageHash</code> 相同，则签名验证通过。</li></ol><hr><h2 id="2-私钥签名的代码示例"><strong>2. 私钥签名的代码示例</strong></h2><p>以 <strong>以太坊 Web3.js</strong> 为例，完整代码如下：</p><h3 id="2-1-交易签名"><strong>2.1 交易签名</strong></h3><p>使用 <code>ethers.js</code> 进行 <strong>交易签名</strong>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> &#123; ethers &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;ethers&quot;</span>);<br><br><span class="hljs-comment">// 1. 生成私钥（或使用已有私钥）</span><br><span class="hljs-keyword">const</span> privateKey = <span class="hljs-string">&quot;0xYOUR_PRIVATE_KEY&quot;</span>;<br><span class="hljs-keyword">const</span> wallet = <span class="hljs-keyword">new</span> ethers.<span class="hljs-title class_">Wallet</span>(privateKey);<br><br><span class="hljs-comment">// 2. 构造交易</span><br><span class="hljs-keyword">const</span> tx = &#123;<br>  <span class="hljs-attr">to</span>: <span class="hljs-string">&quot;0xRecipientAddress&quot;</span>,<br>  <span class="hljs-attr">value</span>: ethers.<span class="hljs-property">utils</span>.<span class="hljs-title function_">parseEther</span>(<span class="hljs-string">&quot;0.1&quot;</span>), <span class="hljs-comment">// 发送 0.1 ETH</span><br>  <span class="hljs-attr">gasLimit</span>: <span class="hljs-number">21000</span>,<br>  <span class="hljs-attr">gasPrice</span>: ethers.<span class="hljs-property">utils</span>.<span class="hljs-title function_">parseUnits</span>(<span class="hljs-string">&quot;20&quot;</span>, <span class="hljs-string">&quot;gwei&quot;</span>),<br>  <span class="hljs-attr">nonce</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 交易计数</span><br>  <span class="hljs-attr">chainId</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 以太坊主网</span><br>&#125;;<br><br><span class="hljs-comment">// 3. 签名交易</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">signTransaction</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> signedTx = <span class="hljs-keyword">await</span> wallet.<span class="hljs-title function_">signTransaction</span>(tx);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;签名后的交易: &quot;</span>, signedTx);<br>&#125;<br><br><span class="hljs-title function_">signTransaction</span>();<br></code></pre></td></tr></table></figure><p>🔹 <strong>流程解析</strong></p><ul><li><code>wallet.signTransaction(tx)</code>：使用 <strong>私钥对交易进行 ECDSA 签名</strong>，返回 <code>(r, s, v)</code>。</li><li><code>signedTx</code>：返回 <strong>已签名的交易数据</strong>，可以直接广播到区块链网络。</li></ul><hr><h3 id="2-2-消息签名"><strong>2.2 消息签名</strong></h3><p>使用 <code>ethers.js</code> 进行 <strong>消息签名</strong>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> message = <span class="hljs-string">&quot;Hello, Web3!&quot;</span>;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">signMessage</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> signature = <span class="hljs-keyword">await</span> wallet.<span class="hljs-title function_">signMessage</span>(message);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;签名:&quot;</span>, signature);<br>&#125;<br><span class="hljs-title function_">signMessage</span>();<br></code></pre></td></tr></table></figure><p>🔹 <strong>流程解析</strong></p><ul><li><code>wallet.signMessage(message)</code> 计算 <code>Keccak-256</code> 哈希，然后用私钥进行 ECDSA 签名，返回 <code>(r, s, v)</code>。</li><li>任何人都可以使用公钥 <strong>验证签名的合法性</strong>。</li></ul><hr><h3 id="2-3-EIP-712-结构化签名"><strong>2.3 EIP-712 结构化签名</strong></h3><p>EIP-712 让签名 <strong>更安全</strong>，用于 <strong>DApp 授权（如 OpenSea NFT 签名）</strong>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> domain = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;MyDApp&quot;</span>,<br>  <span class="hljs-attr">version</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>  <span class="hljs-attr">chainId</span>: <span class="hljs-number">1</span>,<br>&#125;;<br><br><span class="hljs-keyword">const</span> message = &#123;<br>  <span class="hljs-attr">action</span>: <span class="hljs-string">&quot;Login&quot;</span>,<br>  <span class="hljs-attr">user</span>: <span class="hljs-string">&quot;0xYourAddress&quot;</span>,<br>&#125;;<br><br><span class="hljs-keyword">const</span> types = &#123;<br>  <span class="hljs-title class_">Login</span>: [<br>    &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;action&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;string&quot;</span> &#125;,<br>    &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;address&quot;</span> &#125;,<br>  ],<br>&#125;;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">signTypedData</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> signature = <span class="hljs-keyword">await</span> wallet.<span class="hljs-title function_">_signTypedData</span>(domain, types, message);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;EIP-712 签名:&quot;</span>, signature);<br>&#125;<br><br><span class="hljs-title function_">signTypedData</span>();<br></code></pre></td></tr></table></figure><p>🔹 <strong>流程解析</strong></p><ul><li><code>EIP-712</code> 结构化数据签名 <strong>避免了签名欺骗攻击</strong>（如伪造交易授权）。</li><li><code>wallet._signTypedData(domain, types, message)</code> 生成 <code>(r, s, v)</code> 并返回签名。</li></ul><hr><h2 id="3-签名的安全性"><strong>3. 签名的安全性</strong></h2><h3 id="🔹-3-1-签名是否暴露私钥？"><strong>🔹 3.1 签名是否暴露私钥？</strong></h3><p>不会！签名 <code>(r, s, v)</code> 只是证明 <strong>私钥持有者确认了交易或消息</strong>，但不会泄露私钥本身。</p><h3 id="🔹-3-2-如何验证签名？"><strong>🔹 3.2 如何验证签名？</strong></h3><p>验证签名时，DApp 或智能合约可以使用 <strong>公钥恢复</strong>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> recoveredAddress = ethers.<span class="hljs-property">utils</span>.<span class="hljs-title function_">verifyMessage</span>(message, signature);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;签名地址:&quot;</span>, recoveredAddress);<br></code></pre></td></tr></table></figure><p>如果 <code>recoveredAddress === wallet.address</code>，则说明签名合法。</p><h3 id="🔹-3-3-可能的攻击"><strong>🔹 3.3 可能的攻击</strong></h3><ol><li><strong>重放攻击</strong>：<ul><li>攻击者可重复使用签名发起相同交易（需 nonce 保护）。</li></ul></li><li><strong>钓鱼攻击</strong>：<ul><li>恶意 DApp 可能诱导用户签名恶意消息，导致资产被盗（EIP-712 结构化签名可以防止此问题）。</li></ul></li></ol><hr><h2 id="4-总结"><strong>4. 总结</strong></h2><table><thead><tr><th>签名类型</th><th>目的</th><th>是否上链</th><th>典型用途</th></tr></thead><tbody><tr><td>交易签名</td><td>授权交易</td><td>✅ 需要上链</td><td>ETH 转账、调用智能合约</td></tr><tr><td>消息签名</td><td>身份认证、链下授权</td><td>❌ 不上链</td><td>登录验证、NFT 交易授权</td></tr><tr><td>EIP-712</td><td>结构化数据签名，防钓鱼</td><td>❌ 不上链</td><td>OpenSea NFT 签名、DApp 授权</td></tr></tbody></table><p>💡 <strong>私钥签名的核心在于：</strong></p><ul><li><strong>利用 ECDSA 算法生成 <code>(r, s, v)</code> 签名</strong></li><li><strong>保证身份认证、数据完整性</strong></li><li><strong>支持链上交易和链下授权</strong></li><li><strong>避免私钥泄露，使用 EIP-712 提高安全性</strong></li></ul><h3 id="钱包连接的本质"><strong>钱包连接的本质</strong></h3><p>Web3 <strong>钱包连接（Wallet Connection）</strong> 是指 <strong>去中心化应用（DApp）</strong> 通过 Web3 API（如 <code>window.ethereum</code>）与用户的钱包（如 MetaMask、WalletConnect）建立通信，以便用户可以安全地签名交易、授权 DApp 访问资产或进行身份认证。</p><p>本质上，钱包连接是 <strong>DApp 与钱包之间的通信协议</strong>，它不涉及私钥传输，而是让 DApp 通过 <strong>公钥地址</strong> 识别用户，并让用户用私钥签名授权请求。</p><h1>钱包连接的本质</h1><h2 id="1-钱包连接的核心概念"><strong>1. 钱包连接的核心概念</strong></h2><h3 id="✅-去中心化身份（DID）">✅ <strong>去中心化身份（DID）</strong></h3><ul><li>DApp 不存储用户密码，而是使用 <strong>钱包地址</strong> 作为身份标识。</li><li><strong>用户通过钱包签名认证</strong>，证明自己是地址的拥有者。</li></ul><h3 id="✅-钱包不暴露私钥">✅ <strong>钱包不暴露私钥</strong></h3><ul><li><strong>钱包只负责签名</strong>，不会暴露私钥。</li><li><strong>DApp 通过公钥地址恢复签名</strong>，验证用户身份。</li></ul><h3 id="✅-通信协议">✅ <strong>通信协议</strong></h3><ul><li><strong>EIP-1193 标准</strong> 定义了 Web3 钱包通信方式。</li><li>通过 <strong>JSON-RPC 远程调用</strong> 钱包 API 进行交互。</li></ul><hr><h2 id="2-钱包连接的工作流程"><strong>2. 钱包连接的工作流程</strong></h2><p>钱包连接主要包含 4 个关键步骤：</p><h3 id="🔹-2-1-DApp-请求连接"><strong>🔹 2.1 DApp 请求连接</strong></h3><p>DApp 通过 <code>window.ethereum.request(&#123; method: 'eth_requestAccounts' &#125;)</code> 请求用户连接钱包。</p><h3 id="🔹-2-2-用户授权"><strong>🔹 2.2 用户授权</strong></h3><p>钱包弹出授权窗口，用户点击“连接”后，DApp 获取钱包地址。</p><h3 id="🔹-2-3-DApp-记录用户地址"><strong>🔹 2.3 DApp 记录用户地址</strong></h3><p>DApp 将 <code>walletAddress</code> 存储在 <strong>前端状态</strong> 或 <strong>后端数据库</strong>，用于身份识别。</p><h3 id="🔹-2-4-交易或签名交互"><strong>🔹 2.4 交易或签名交互</strong></h3><p>用户可在 DApp 内：</p><ol><li><strong>签名交易（如 ETH 转账、智能合约调用）</strong></li><li><strong>签名消息（如 DApp 登录验证）</strong></li></ol><p>📌 <strong>Mermaid 序列图</strong></p><pre><code class=" mermaid">sequenceDiagram    participant DApp as 去中心化应用(DApp)    participant User as 用户    participant Wallet as Web3 钱包    DApp-&gt;&gt;Wallet: 连接请求 (eth_requestAccounts)    Wallet-&gt;&gt;User: 弹出连接授权窗口    User-&gt;&gt;Wallet: 授权连接    Wallet-&gt;&gt;DApp: 返回钱包地址    DApp--&gt;&gt;User: 连接成功，用户身份认证完成</code></pre><hr><h2 id="3-钱包连接的代码实现"><strong>3. 钱包连接的代码实现</strong></h2><h3 id="🔹-3-1-基础连接"><strong>🔹 3.1 基础连接</strong></h3><p>使用 <strong>MetaMask + ethers.js</strong> 连接钱包：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">connectWallet</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>) &#123;<br>        <span class="hljs-keyword">const</span> provider = <span class="hljs-keyword">new</span> ethers.<span class="hljs-property">providers</span>.<span class="hljs-title class_">Web3Provider</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>);<br>        <span class="hljs-keyword">const</span> accounts = <span class="hljs-keyword">await</span> provider.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;eth_requestAccounts&quot;</span>, []);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;钱包地址:&quot;</span>, accounts[<span class="hljs-number">0</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;请安装 MetaMask&quot;</span>);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><hr><h3 id="🔹-3-2-签名登录"><strong>🔹 3.2 签名登录</strong></h3><p>DApp 通过 <strong>钱包签名</strong> 验证用户身份：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">signMessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> provider = <span class="hljs-keyword">new</span> ethers.<span class="hljs-property">providers</span>.<span class="hljs-title class_">Web3Provider</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>);<br>    <span class="hljs-keyword">const</span> signer = provider.<span class="hljs-title function_">getSigner</span>();<br>    <span class="hljs-keyword">const</span> address = <span class="hljs-keyword">await</span> signer.<span class="hljs-title function_">getAddress</span>();<br>    <br>    <span class="hljs-keyword">const</span> message = <span class="hljs-string">`Login to MyDApp: <span class="hljs-subst">$&#123;<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()&#125;</span>`</span>;<br>    <span class="hljs-keyword">const</span> signature = <span class="hljs-keyword">await</span> signer.<span class="hljs-title function_">signMessage</span>(message);<br><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;用户地址:&quot;</span>, address);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;签名:&quot;</span>, signature);<br>&#125;;<br></code></pre></td></tr></table></figure><p>✅ <strong>原理</strong>：</p><ul><li>钱包 <strong>不泄露私钥</strong>，只返回签名。</li><li>DApp 使用 <strong><code>ethers.utils.verifyMessage(message, signature)</code></strong> 验证身份。</li></ul><hr><h3 id="🔹-3-3-交易签名"><strong>🔹 3.3 交易签名</strong></h3><p>如果用户要 <strong>发送交易</strong>，钱包会弹窗确认：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">sendTransaction</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> provider = <span class="hljs-keyword">new</span> ethers.<span class="hljs-property">providers</span>.<span class="hljs-title class_">Web3Provider</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>);<br>    <span class="hljs-keyword">const</span> signer = provider.<span class="hljs-title function_">getSigner</span>();<br><br>    <span class="hljs-keyword">const</span> tx = <span class="hljs-keyword">await</span> signer.<span class="hljs-title function_">sendTransaction</span>(&#123;<br>        <span class="hljs-attr">to</span>: <span class="hljs-string">&quot;0xRecipientAddress&quot;</span>,<br>        <span class="hljs-attr">value</span>: ethers.<span class="hljs-property">utils</span>.<span class="hljs-title function_">parseEther</span>(<span class="hljs-string">&quot;0.01&quot;</span>),<br>    &#125;);<br><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;交易哈希:&quot;</span>, tx.<span class="hljs-property">hash</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p>✅ <strong>钱包连接后，DApp 可以请求用户签名交易，并发送到区块链！</strong></p><hr><h2 id="4-钱包连接的安全性"><strong>4. 钱包连接的安全性</strong></h2><h3 id="✅-为什么-DApp-只能访问地址，而无法获取私钥？">✅ <strong>为什么 DApp 只能访问地址，而无法获取私钥？</strong></h3><ul><li>钱包 <strong>使用 EIP-1193</strong> 标准，只允许 DApp 通过 <code>eth_requestAccounts</code> 获取地址。</li><li><strong>钱包只返回公钥地址，不暴露私钥</strong>，所有操作都由用户手动确认。</li></ul><h3 id="❌-可能的安全风险">❌ <strong>可能的安全风险</strong></h3><ol><li><p><strong>恶意 DApp 伪造授权</strong></p><ul><li>解决方案：使用 <strong>EIP-712 结构化签名</strong> 避免签名欺骗攻击。</li></ul></li><li><p><strong>前端劫持攻击</strong></p><ul><li>解决方案：避免 <strong>直接信任前端</strong>，后端需验证签名。</li></ul></li></ol><hr><h2 id="5-钱包连接的底层协议"><strong>5. 钱包连接的底层协议</strong></h2><h3 id="🔹-JSON-RPC-调用"><strong>🔹 JSON-RPC 调用</strong></h3><p>钱包通过 <strong>JSON-RPC</strong> 协议与 DApp 交互，主要 API：</p><table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td><code>eth_requestAccounts</code></td><td>请求用户连接钱包</td></tr><tr><td><code>eth_accounts</code></td><td>获取已连接的钱包地址</td></tr><tr><td><code>personal_sign</code></td><td>签名消息</td></tr><tr><td><code>eth_sendTransaction</code></td><td>发送交易</td></tr></tbody></table><p>📌 <strong>示例 JSON-RPC 调用</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eth_requestAccounts&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>📌 <strong>示例返回</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;0xYourWalletAddress&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><hr><h2 id="6-总结"><strong>6. 总结</strong></h2><table><thead><tr><th><strong>核心概念</strong></th><th><strong>解释</strong></th></tr></thead><tbody><tr><td><strong>身份认证</strong></td><td>通过钱包地址和签名进行身份验证</td></tr><tr><td><strong>去中心化</strong></td><td>不需要用户名密码，用户完全控制私钥</td></tr><tr><td><strong>交易授权</strong></td><td>用户用钱包签名，确认交易</td></tr><tr><td><strong>EIP-1193</strong></td><td>标准化钱包与 DApp 交互方式</td></tr></tbody></table><p>✅ <strong>DApp 只能访问钱包地址，不会获取私钥</strong><br>✅ <strong>用户通过签名授权，确保交易安全</strong><br>✅ <strong>钱包连接后，DApp 可与区块链交互，用户完全掌控资产</strong></p><p>🚀 <strong>钱包连接是 Web3 去中心化身份认证的关键，确保用户隐私和安全！</strong> 🔐</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>aave1</title>
    <link href="/2025/02/09/aave1/"/>
    <url>/2025/02/09/aave1/</url>
    
    <content type="html"><![CDATA[<h1>Aave借贷业务的时序图</h1><pre><code class=" mermaid">sequenceDiagram    participant User as 用户    participant LP as LendingPool    participant ERC20 as ERC20代币合约    participant aToken as aToken合约    participant DebtToken as 债务代币合约    participant Liquidator as 清算者    %% 存款流程    Note over User,LP: 存款流程    User-&gt;&gt;LP: deposit(asset, amount, onBehalfOf, referralCode)    LP-&gt;&gt;ERC20: transferFrom(User, LP, amount)    LP-&gt;&gt;aToken: mint(onBehalfOf, amount)    LP--&gt;&gt;User: 存款成功（获得aToken）    %% 借款流程    Note over User,LP: 借款流程    User-&gt;&gt;LP: borrow(asset, amount, interestRateMode, referralCode, onBehalfOf)    LP-&gt;&gt;DebtToken: mint(onBehalfOf, amount)    LP-&gt;&gt;ERC20: transfer(asset, User, amount)    LP--&gt;&gt;User: 借款成功（获得资金）    %% 还款流程    Note over User,LP: 还款流程    User-&gt;&gt;LP: repay(asset, amount, rateMode, onBehalfOf)    LP-&gt;&gt;ERC20: transferFrom(User, LP, amount)    LP-&gt;&gt;DebtToken: burn(onBehalfOf, amount)    LP--&gt;&gt;User: 还款成功    %% 清算流程（当借款人抵押不足时）    Note over Liquidator,LP: 清算流程    Liquidator-&gt;&gt;LP: liquidationCall(borrower, collateralAsset, debtAsset, debtToCover, receiveAToken)    LP-&gt;&gt;ERC20: transferFrom(Liquidator, LP, debtToCover)    LP-&gt;&gt;DebtToken: burn(borrower, debtToCover)    LP-&gt;&gt;aToken: redeem(borrower, liquidatedCollateral)    LP-&gt;&gt;Liquidator: transfer(collateralAsset, liquidatedCollateral)    LP--&gt;&gt;Liquidator: 清算完成</code></pre><h1>Aave 借贷核心计算逻辑及公式示例</h1><p>Aave 协议内部采用高精度数学运算（通常使用 ray 单位，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>27</mn></msup></mrow><annotation encoding="application/x-tex">10^{27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">27</span></span></span></span></span></span></span></span></span></span></span></span> 精度）来计算利率、利息累积、风险控制等。下文列出了各项主要计算公式，并通过具体数值示例加以说明。</p><hr><h2 id="1-利率计算">1. 利率计算</h2><h3 id="1-1-利用率（Utilization-Rate）">1.1 利用率（Utilization Rate）</h3><p>利用率衡量储备中借款金额所占的比例，公式为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>U</mi><mo>=</mo><mfrac><mtext>Total Borrows</mtext><mrow><mtext>Available Liquidity</mtext><mo>+</mo><mtext>Total Borrows</mtext></mrow></mfrac></mrow><annotation encoding="application/x-tex">U = \frac{\text{Total Borrows}}{\text{Available Liquidity} + \text{Total Borrows}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.2519em;vertical-align:-0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Available Liquidity</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Total Borrows</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Total Borrows</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><strong>示例</strong><br>假设：</p><ul><li>当前借款总额（Total Borrows） = 300,000 USDC</li><li>储备中的可用流动性（Available Liquidity） = 700,000 USDC</li></ul><p>则计算利用率：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>U</mi><mo>=</mo><mfrac><mrow><mn>300</mn><mtext> </mtext><mn>000</mn></mrow><mrow><mn>700</mn><mtext> </mtext><mn>000</mn><mo>+</mo><mn>300</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>=</mo><mfrac><mrow><mn>300</mn><mtext> </mtext><mn>000</mn></mrow><mrow><mn>1</mn><mtext> </mtext><mn>000</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>=</mo><mn>0.3</mn><mspace width="1em"><mo stretchy="false">(</mo><mn>30</mn><mi mathvariant="normal">%</mi><mo stretchy="false">)</mo></mspace></mrow><annotation encoding="application/x-tex">U = \frac{300\,000}{700\,000 + 300\,000} = \frac{300\,000}{1\,000\,000} = 0.3 \quad (30\%)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0908em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">700</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">300</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">300</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">300</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.3</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">30%</span><span class="mclose">)</span></span></span></span></span></p><hr><h3 id="1-2-借款利率（Borrow-Rates）">1.2 借款利率（Borrow Rates）</h3><p>Aave 分为<strong>可变借款利率</strong>和<strong>稳定借款利率</strong>，通常均采用分段模型。</p><h4 id="1-2-1-可变借款利率（Variable-Borrow-Rate）">1.2.1 可变借款利率（Variable Borrow Rate）</h4><p>公式为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Variable Borrow Rate</mtext><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Base Variable Rate</mtext><mo>+</mo><mtext>Variable Rate Slope1</mtext><mo>⋅</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mi>U</mi><msub><mi>U</mi><mtext>opt</mtext></msub></mfrac></mstyle><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>U</mi><mo>≤</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Base Variable Rate</mtext><mo>+</mo><mtext>Variable Rate Slope1</mtext><mo>+</mo><mtext>Variable Rate Slope2</mtext><mo>⋅</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><mi>U</mi><mo>−</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow><mrow><mn>1</mn><mo>−</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow></mfrac></mstyle><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>U</mi><mo>&gt;</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\text{Variable Borrow Rate} =\begin{cases}\text{Base Variable Rate} + \text{Variable Rate Slope1} \cdot \dfrac{U}{U_{\text{opt}}}, &amp; U \leq U_{\text{opt}} \\\text{Base Variable Rate} + \text{Variable Rate Slope1} + \text{Variable Rate Slope2} \cdot \dfrac{U - U_{\text{opt}}}{1 - U_{\text{opt}}}, &amp; U &gt; U_{\text{opt}}\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Variable Borrow Rate</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-1.9em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-1.892em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.616em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.616em" style="width:0.8889em" viewbox="0 0 888.89 616" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V616 H384z M384 0 H504 V616 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.616em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.616em" style="width:0.8889em" viewbox="0 0 888.89 616" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V616 H384z M384 0 H504 V616 H384z"/></svg></span></span><span style="top:-4.9em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5824em;"><span style="top:-4.5824em;"><span class="pstrut" style="height:3.3603em;"></span><span class="mord"><span class="mord text"><span class="mord">Base Variable Rate</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Variable Rate Slope1</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.3603em;"></span><span class="mord"><span class="mord text"><span class="mord">Base Variable Rate</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Variable Rate Slope1</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Variable Rate Slope2</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0824em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5824em;"><span style="top:-4.5824em;"><span class="pstrut" style="height:3.3603em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.3603em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0824em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><strong>示例 1</strong>（当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>≤</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow><annotation encoding="application/x-tex">U \leq U_{\text{opt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8193em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>）：<br>假设参数：</p><ul><li>基准可变利率（Base Variable Rate） = 2%</li><li>斜率1（Variable Rate Slope1） = 6%</li><li>最优利用率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mtext>opt</mtext></msub><mo>=</mo><mn>80</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">U_{\text{opt}} = 80\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">80%</span></span></span></span> (即 0.8)</li><li>当前利用率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>=</mo><mn>30</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">U = 30\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">30%</span></span></span></span> (即 0.3)</li></ul><p>计算：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Variable Borrow Rate</mtext><mo>=</mo><mn>0.02</mn><mo>+</mo><mn>0.06</mn><mo>×</mo><mfrac><mn>0.3</mn><mn>0.8</mn></mfrac><mo>=</mo><mn>0.02</mn><mo>+</mo><mn>0.06</mn><mo>×</mo><mn>0.375</mn><mo>=</mo><mn>0.02</mn><mo>+</mo><mn>0.0225</mn><mo>=</mo><mn>0.0425</mn><mspace width="1em"><mo stretchy="false">(</mo><mn>4.25</mn><mi mathvariant="normal">%</mi><mtext> 年利率</mtext><mo stretchy="false">)</mo></mspace></mrow><annotation encoding="application/x-tex">\text{Variable Borrow Rate} = 0.02 + 0.06 \times \frac{0.3}{0.8} = 0.02 + 0.06 \times 0.375 = 0.02 + 0.0225 = 0.0425 \quad (4.25\%\ \text{年利率})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Variable Borrow Rate</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.02</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.06</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.8</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.02</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.06</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.375</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.02</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.0225</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.0425</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">4.25%</span><span class="mspace"> </span><span class="mord text"><span class="mord cjk_fallback">年利率</span></span><span class="mclose">)</span></span></span></span></span></p><p><strong>示例 2</strong>（当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>&gt;</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow><annotation encoding="application/x-tex">U &gt; U_{\text{opt}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>）：<br>假设参数不变，但当前利用率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>=</mo><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">U = 90\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">90%</span></span></span></span> (即 0.9)<br>计算：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Variable Borrow Rate</mtext><mo>=</mo><mn>0.02</mn><mo>+</mo><mn>0.06</mn><mo>+</mo><mn>1.00</mn><mo>×</mo><mfrac><mrow><mn>0.9</mn><mo>−</mo><mn>0.8</mn></mrow><mrow><mn>1</mn><mo>−</mo><mn>0.8</mn></mrow></mfrac><mo>=</mo><mn>0.08</mn><mo>+</mo><mn>1.00</mn><mo>×</mo><mfrac><mn>0.1</mn><mn>0.2</mn></mfrac><mo>=</mo><mn>0.08</mn><mo>+</mo><mn>0.5</mn><mo>=</mo><mn>0.58</mn><mspace width="1em"><mo stretchy="false">(</mo><mn>58</mn><mi mathvariant="normal">%</mi><mtext> 年利率</mtext><mo stretchy="false">)</mo></mspace></mrow><annotation encoding="application/x-tex">\text{Variable Borrow Rate} = 0.02 + 0.06 + 1.00 \times \frac{0.9 - 0.8}{1 - 0.8} = 0.08 + 1.00 \times \frac{0.1}{0.2} = 0.08 + 0.5 = 0.58 \quad (58\%\ \text{年利率})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Variable Borrow Rate</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.02</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.06</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.00</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0908em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.8</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.9</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.08</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.00</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.08</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.58</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">58%</span><span class="mspace"> </span><span class="mord text"><span class="mord cjk_fallback">年利率</span></span><span class="mclose">)</span></span></span></span></span></p><blockquote><p><strong>注意：</strong> 上述示例中，Variable Rate Slope2 取值为 100%（1.00），实际参数由协议配置决定。</p></blockquote><h4 id="1-2-2-稳定借款利率（Stable-Borrow-Rate）">1.2.2 稳定借款利率（Stable Borrow Rate）</h4><p>公式与可变借款利率类似：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Stable Borrow Rate</mtext><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Base Stable Rate</mtext><mo>+</mo><mtext>Stable Rate Slope1</mtext><mo>⋅</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mi>U</mi><msub><mi>U</mi><mtext>opt</mtext></msub></mfrac></mstyle><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>U</mi><mo>≤</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>Base Stable Rate</mtext><mo>+</mo><mtext>Stable Rate Slope1</mtext><mo>+</mo><mtext>Stable Rate Slope2</mtext><mo>⋅</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><mi>U</mi><mo>−</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow><mrow><mn>1</mn><mo>−</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow></mfrac></mstyle><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>U</mi><mo>&gt;</mo><msub><mi>U</mi><mtext>opt</mtext></msub></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\text{Stable Borrow Rate} =\begin{cases}\text{Base Stable Rate} + \text{Stable Rate Slope1} \cdot \dfrac{U}{U_{\text{opt}}}, &amp; U \leq U_{\text{opt}} \\\text{Base Stable Rate} + \text{Stable Rate Slope1} + \text{Stable Rate Slope2} \cdot \dfrac{U - U_{\text{opt}}}{1 - U_{\text{opt}}}, &amp; U &gt; U_{\text{opt}}\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Stable Borrow Rate</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-1.9em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-1.892em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.616em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.616em" style="width:0.8889em" viewbox="0 0 888.89 616" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V616 H384z M384 0 H504 V616 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.616em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.616em" style="width:0.8889em" viewbox="0 0 888.89 616" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V616 H384z M384 0 H504 V616 H384z"/></svg></span></span><span style="top:-4.9em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5824em;"><span style="top:-4.5824em;"><span class="pstrut" style="height:3.3603em;"></span><span class="mord"><span class="mord text"><span class="mord">Base Stable Rate</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Stable Rate Slope1</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.3603em;"></span><span class="mord"><span class="mord text"><span class="mord">Base Stable Rate</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Stable Rate Slope1</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Stable Rate Slope2</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0824em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5824em;"><span style="top:-4.5824em;"><span class="pstrut" style="height:3.3603em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.3603em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0824em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><strong>示例</strong>：<br>假设参数：</p><ul><li>基准稳定利率（Base Stable Rate） = 3%</li><li>稳定利率斜率1（Stable Rate Slope1） = 8%</li><li>稳定利率斜率2（Stable Rate Slope2） = 120%</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mtext>opt</mtext></msub><mo>=</mo><mn>0.8</mn></mrow><annotation encoding="application/x-tex">U_{\text{opt}} = 0.8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">opt</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.8</span></span></span></span></li></ul><p><strong>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>=</mo><mn>0.3</mn></mrow><annotation encoding="application/x-tex">U = 0.3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.3</span></span></span></span> 时</strong>：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Stable Borrow Rate</mtext><mo>=</mo><mn>0.03</mn><mo>+</mo><mn>0.08</mn><mo>×</mo><mfrac><mn>0.3</mn><mn>0.8</mn></mfrac><mo>=</mo><mn>0.03</mn><mo>+</mo><mn>0.08</mn><mo>×</mo><mn>0.375</mn><mo>=</mo><mn>0.03</mn><mo>+</mo><mn>0.03</mn><mo>=</mo><mn>0.06</mn><mspace width="1em"><mo stretchy="false">(</mo><mn>6</mn><mi mathvariant="normal">%</mi><mtext> 年利率</mtext><mo stretchy="false">)</mo></mspace></mrow><annotation encoding="application/x-tex">\text{Stable Borrow Rate} = 0.03 + 0.08 \times \frac{0.3}{0.8} = 0.03 + 0.08 \times 0.375 = 0.03 + 0.03 = 0.06 \quad (6\%\ \text{年利率})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Stable Borrow Rate</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.03</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.08</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.8</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.03</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.08</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.375</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.03</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.03</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.06</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">6%</span><span class="mspace"> </span><span class="mord text"><span class="mord cjk_fallback">年利率</span></span><span class="mclose">)</span></span></span></span></span></p><p><strong>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>=</mo><mn>0.9</mn></mrow><annotation encoding="application/x-tex">U = 0.9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.9</span></span></span></span> 时</strong>：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Stable Borrow Rate</mtext><mo>=</mo><mn>0.03</mn><mo>+</mo><mn>0.08</mn><mo>+</mo><mn>1.20</mn><mo>×</mo><mfrac><mrow><mn>0.9</mn><mo>−</mo><mn>0.8</mn></mrow><mn>0.2</mn></mfrac><mo>=</mo><mn>0.11</mn><mo>+</mo><mn>1.20</mn><mo>×</mo><mn>0.5</mn><mo>=</mo><mn>0.11</mn><mo>+</mo><mn>0.6</mn><mo>=</mo><mn>0.71</mn><mspace width="1em"><mo stretchy="false">(</mo><mn>71</mn><mi mathvariant="normal">%</mi><mtext> 年利率</mtext><mo stretchy="false">)</mo></mspace></mrow><annotation encoding="application/x-tex">\text{Stable Borrow Rate} = 0.03 + 0.08 + 1.20 \times \frac{0.9 - 0.8}{0.2} = 0.11 + 1.20 \times 0.5 = 0.11 + 0.6 = 0.71 \quad (71\%\ \text{年利率})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Stable Borrow Rate</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.03</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.08</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.20</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.9</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.11</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.20</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.11</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.6</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.71</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">71%</span><span class="mspace"> </span><span class="mord text"><span class="mord cjk_fallback">年利率</span></span><span class="mclose">)</span></span></span></span></span></p><hr><h3 id="1-3-存款利率（Liquidity-Rate）">1.3 存款利率（Liquidity Rate）</h3><p>存款利率表示存款者获得的收益，其计算综合了稳定和可变借款的利率，公式为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Liquidity Rate</mtext><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mstyle scriptlevel="0" displaystyle="true"><mrow><mo fence="true">(</mo><mfrac><mrow><mtext>Stable Borrows</mtext><mo>×</mo><mtext>Stable Borrow Rate</mtext><mo>+</mo><mtext>Variable Borrows</mtext><mo>×</mo><mtext>Variable Borrow Rate</mtext></mrow><mtext>Total Borrows</mtext></mfrac><mo fence="true">)</mo></mrow><mo>×</mo><mrow><mo fence="true">(</mo><mn>1</mn><mo>−</mo><mtext>Reserve Factor</mtext><mo fence="true">)</mo></mrow><mo separator="true">,</mo></mstyle></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if Total Borrows</mtext><mo>&gt;</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mn>0</mn><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if Total Borrows</mtext><mo>=</mo><mn>0</mn></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\text{Liquidity Rate} =\begin{cases}\displaystyle \left(\frac{\text{Stable Borrows} \times \text{Stable Borrow Rate} + \text{Variable Borrows} \times \text{Variable Borrow Rate}}{\text{Total Borrows}}\right) \times \left(1 - \text{Reserve Factor}\right), &amp; \text{if Total Borrows} &gt; 0 \\0, &amp; \text{if Total Borrows} = 0\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Liquidity Rate</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.84em;vertical-align:-1.67em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-2.5em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.492em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.016em" style="width:0.8889em" viewbox="0 0 888.89 16" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V16 H384z M384 0 H504 V16 H384z"/></svg></span></span><span style="top:-3.15em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.292em;"><span class="pstrut" style="height:3.15em;"></span><span style="height:0.016em;width:0.8889em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.8889em" height="0.016em" style="width:0.8889em" viewbox="0 0 888.89 16" preserveaspectratio="xMinYMin"><path d="M384 0 H504 V16 H384z M384 0 H504 V16 H384z"/></svg></span></span><span style="top:-4.3em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.17em;"><span style="top:-4.17em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Total Borrows</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Stable Borrows</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Stable Borrow Rate</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Variable Borrows</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Variable Borrow Rate</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Reserve Factor</span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span></span></span><span style="top:-2.212em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord">0</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.67em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.17em;"><span style="top:-4.17em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord text"><span class="mord">if Total Borrows</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span><span style="top:-2.212em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord text"><span class="mord">if Total Borrows</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.67em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><strong>示例</strong><br>假设：</p><ul><li>总借款额（Total Borrows） = 1,000,000 USDC</li><li>稳定借款（Stable Borrows） = 600,000 USDC，利率为 6%</li><li>可变借款（Variable Borrows） = 400,000 USDC，利率为 4%</li><li>协议储备比例（Reserve Factor） = 10% (0.10)</li></ul><p>计算：</p><ol><li><p>加权借款利率：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mn>600</mn><mtext> </mtext><mn>000</mn><mo>×</mo><mn>0.06</mn><mo>+</mo><mn>400</mn><mtext> </mtext><mn>000</mn><mo>×</mo><mn>0.04</mn></mrow><mrow><mn>1</mn><mtext> </mtext><mn>000</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>=</mo><mfrac><mrow><mn>36</mn><mtext> </mtext><mn>000</mn><mo>+</mo><mn>16</mn><mtext> </mtext><mn>000</mn></mrow><mrow><mn>1</mn><mtext> </mtext><mn>000</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>=</mo><mfrac><mrow><mn>52</mn><mtext> </mtext><mn>000</mn></mrow><mrow><mn>1</mn><mtext> </mtext><mn>000</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>=</mo><mn>0.052</mn><mspace width="1em"><mo stretchy="false">(</mo><mn>5.2</mn><mi mathvariant="normal">%</mi><mo stretchy="false">)</mo></mspace></mrow><annotation encoding="application/x-tex">\frac{600\,000 \times 0.06 + 400\,000 \times 0.04}{1\,000\,000} = \frac{36\,000 + 16\,000}{1\,000\,000} = \frac{52\,000}{1\,000\,000} = 0.052 \quad (5.2\%)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">600</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.06</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">400</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.04</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">36</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">16</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">52</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.052</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">5.2%</span><span class="mclose">)</span></span></span></span></span></p></li><li><p>扣除储备因子后的存款利率：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Liquidity Rate</mtext><mo>=</mo><mn>0.052</mn><mo>×</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mn>0.10</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0.052</mn><mo>×</mo><mn>0.90</mn><mo>=</mo><mn>0.0468</mn><mspace width="1em"><mo stretchy="false">(</mo><mn>4.68</mn><mi mathvariant="normal">%</mi><mtext> 年利率</mtext><mo stretchy="false">)</mo></mspace></mrow><annotation encoding="application/x-tex">\text{Liquidity Rate} = 0.052 \times (1 - 0.10) = 0.052 \times 0.90 = 0.0468 \quad (4.68\%\ \text{年利率})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">Liquidity Rate</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.052</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.10</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">0.052</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.90</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.0468</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">4.68%</span><span class="mspace"> </span><span class="mord text"><span class="mord cjk_fallback">年利率</span></span><span class="mclose">)</span></span></span></span></span></p></li></ol><hr><h2 id="2-利息累积与指数更新">2. 利息累积与指数更新</h2><p>为了精确追踪利息累积，Aave 使用<strong>指数</strong>更新存款和借款状态。下面公式中实际计算均在高精度（ray 单位）下进行，但示例中为便于理解，采用简化的十进制表示。</p><h3 id="2-1-流动性指数（Liquidity-Index）更新">2.1 流动性指数（Liquidity Index）更新</h3><p>公式为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>newLiquidityIndex</mtext><mo>=</mo><mtext>liquidityIndex</mtext><mo>×</mo><mrow><mo fence="true">(</mo><mn>1</mn><mo>+</mo><mfrac><mrow><mtext>Liquidity Rate</mtext><mo>×</mo><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow><mtext>RAY</mtext></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{newLiquidityIndex} = \text{liquidityIndex} \times \left(1 + \frac{\text{Liquidity Rate} \times \Delta t}{\text{RAY}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">newLiquidityIndex</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">liquidityIndex</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">RAY</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Liquidity Rate</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p>其中：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\Delta t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span> 为自上次更新以来的时间（秒）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>RAY</mtext><mo>=</mo><msup><mn>10</mn><mn>27</mn></msup></mrow><annotation encoding="application/x-tex">\text{RAY} = 10^{27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">RAY</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">27</span></span></span></span></span></span></span></span></span></span></span></span>（实际计算中，利率和指数均以 ray 表示）</li></ul><p><strong>示例</strong>（简化版，不考虑 ray 缩放）<br>假设：</p><ul><li>上一时刻流动性指数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>liquidityIndex</mtext><mo>=</mo><mn>1.0</mn></mrow><annotation encoding="application/x-tex">\text{liquidityIndex} = 1.0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">liquidityIndex</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1.0</span></span></span></span></li><li>存款利率为 5% 年化（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">r = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.05</span></span></span></span>）</li><li>时间间隔 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>t</mi><mo>=</mo><mn>86</mn><mtext> </mtext><mn>400</mn></mrow><annotation encoding="application/x-tex">\Delta t = 86\,400</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">86</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">400</span></span></span></span> 秒（1 天）</li></ul><p>首先，将年化利率转换为每秒利率：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>r</mi><mtext>per second</mtext></msub><mo>=</mo><mfrac><mn>0.05</mn><mrow><mn>365</mn><mo>×</mo><mn>24</mn><mo>×</mo><mn>3600</mn></mrow></mfrac><mo>≈</mo><mfrac><mn>0.05</mn><mrow><mn>31</mn><mtext> </mtext><mn>536</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>≈</mo><mn>1.585</mn><mo>×</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>9</mn></mrow></msup></mrow><annotation encoding="application/x-tex">r_{\text{per second}} = \frac{0.05}{365 \times 24 \times 3600} \approx \frac{0.05}{31\,536\,000} \approx 1.585 \times 10^{-9}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">per second</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0908em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">365</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">24</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">3600</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.05</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">31</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">536</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.05</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.585</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span></span></p><p>日增量为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>1.585</mn><mo>×</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>9</mn></mrow></msup><mo>×</mo><mn>86</mn><mtext> </mtext><mn>400</mn><mo>≈</mo><mn>0.000137</mn></mrow><annotation encoding="application/x-tex">1.585 \times 10^{-9} \times 86\,400 \approx 0.000137</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.585</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">86</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">400</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.000137</span></span></span></span></span></p><p>更新后的流动性指数为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>newLiquidityIndex</mtext><mo>=</mo><mn>1.0</mn><mo>×</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mn>0.000137</mn><mo stretchy="false">)</mo><mo>≈</mo><mn>1.000137</mn></mrow><annotation encoding="application/x-tex">\text{newLiquidityIndex} = 1.0 \times (1 + 0.000137) \approx 1.000137</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">newLiquidityIndex</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.0</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.000137</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1.000137</span></span></span></span></span></p><blockquote><p><strong>备注</strong>：在实际合约中所有数值均乘以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>27</mn></msup></mrow><annotation encoding="application/x-tex">10^{27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">27</span></span></span></span></span></span></span></span></span></span></span></span> 表示，确保精度。</p></blockquote><h3 id="2-2-可变借款指数（Variable-Borrow-Index）更新">2.2 可变借款指数（Variable Borrow Index）更新</h3><p>公式类似：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>newVariableBorrowIndex</mtext><mo>=</mo><mtext>variableBorrowIndex</mtext><mo>×</mo><mrow><mo fence="true">(</mo><mn>1</mn><mo>+</mo><mfrac><mrow><mtext>Variable Borrow Rate</mtext><mo>×</mo><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow><mtext>RAY</mtext></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{newVariableBorrowIndex} = \text{variableBorrowIndex} \times \left(1 + \frac{\text{Variable Borrow Rate} \times \Delta t}{\text{RAY}}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">newVariableBorrowIndex</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord text"><span class="mord">variableBorrowIndex</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">RAY</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Variable Borrow Rate</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p><strong>示例</strong>（简化版）<br>假设：</p><ul><li>初始可变借款指数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>variableBorrowIndex</mtext><mo>=</mo><mn>1.0</mn></mrow><annotation encoding="application/x-tex">\text{variableBorrowIndex} = 1.0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">variableBorrowIndex</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1.0</span></span></span></span></li><li>可变借款年化利率为 4%（即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>0.04</mn></mrow><annotation encoding="application/x-tex">r = 0.04</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.04</span></span></span></span>）</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>t</mi><mo>=</mo><mn>86</mn><mtext> </mtext><mn>400</mn></mrow><annotation encoding="application/x-tex">\Delta t = 86\,400</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">86</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">400</span></span></span></span> 秒（1 天）</li></ul><p>计算每秒利率：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>r</mi><mtext>per second</mtext></msub><mo>=</mo><mfrac><mn>0.04</mn><mrow><mn>31</mn><mtext> </mtext><mn>536</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>≈</mo><mn>1.268</mn><mo>×</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>9</mn></mrow></msup></mrow><annotation encoding="application/x-tex">r_{\text{per second}} = \frac{0.04}{31\,536\,000} \approx 1.268 \times 10^{-9}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">per second</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">31</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">536</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.04</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.268</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span></span></p><p>日增量：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>1.268</mn><mo>×</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>9</mn></mrow></msup><mo>×</mo><mn>86</mn><mtext> </mtext><mn>400</mn><mo>≈</mo><mn>0.000109</mn></mrow><annotation encoding="application/x-tex">1.268 \times 10^{-9} \times 86\,400 \approx 0.000109</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.268</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">86</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">400</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.000109</span></span></span></span></span></p><p>更新后的可变借款指数为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>newVariableBorrowIndex</mtext><mo>=</mo><mn>1.0</mn><mo>×</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mn>0.000109</mn><mo stretchy="false">)</mo><mo>≈</mo><mn>1.000109</mn></mrow><annotation encoding="application/x-tex">\text{newVariableBorrowIndex} = 1.0 \times (1 + 0.000109) \approx 1.000109</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">newVariableBorrowIndex</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.0</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.000109</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1.000109</span></span></span></span></span></p><hr><h2 id="3-健康因子（Health-Factor）计算">3. 健康因子（Health Factor）计算</h2><p>健康因子用于衡量借款人账户安全性，其计算公式为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Health Factor</mtext><mo>=</mo><mfrac><mrow><mtext>Collateral Value</mtext><mo>×</mo><mtext>Liquidation Threshold</mtext></mrow><mtext>Total Borrowed Value</mtext></mfrac></mrow><annotation encoding="application/x-tex">\text{Health Factor} = \frac{\text{Collateral Value} \times \text{Liquidation Threshold}}{\text{Total Borrowed Value}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Health Factor</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Total Borrowed Value</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Collateral Value</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Liquidation Threshold</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><strong>示例</strong><br>假设：</p><ul><li>抵押品价值（Collateral Value） = $150,000</li><li>清算阈值（Liquidation Threshold） = 80% (0.8)</li><li>借款总额（Total Borrowed Value） = $100,000</li></ul><p>则健康因子为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Health Factor</mtext><mo>=</mo><mfrac><mrow><mn>150</mn><mtext> </mtext><mn>000</mn><mo>×</mo><mn>0.8</mn></mrow><mrow><mn>100</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>=</mo><mfrac><mrow><mn>120</mn><mtext> </mtext><mn>000</mn></mrow><mrow><mn>100</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>=</mo><mn>1.2</mn></mrow><annotation encoding="application/x-tex">\text{Health Factor} = \frac{150\,000 \times 0.8}{100\,000} = \frac{120\,000}{100\,000} = 1.2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Health Factor</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">100</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">150</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">100</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">120</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1.2</span></span></span></span></span></p><p>若健康因子低于 1，则表明借款人风险较高，可能触发清算。</p><hr><h2 id="4-时间利率转换">4. 时间利率转换</h2><p>当利率以年化形式给出时，需转换为每秒利率，公式为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>r</mi><mtext>per second</mtext></msub><mo>=</mo><mfrac><msub><mi>r</mi><mtext>annual</mtext></msub><mrow><mn>365</mn><mo>×</mo><mn>24</mn><mo>×</mo><mn>3600</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">r_{\text{per second}} = \frac{r_{\text{annual}}}{365 \times 24 \times 3600}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">per second</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8769em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">365</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">24</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">3600</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">annual</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><strong>示例</strong><br>对于年化利率 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mtext>annual</mtext></msub><mo>=</mo><mn>5</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">r_{\text{annual}} = 5\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">annual</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">5%</span></span></span></span>（即 0.05）：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>r</mi><mtext>per second</mtext></msub><mo>=</mo><mfrac><mn>0.05</mn><mrow><mn>31</mn><mtext> </mtext><mn>536</mn><mtext> </mtext><mn>000</mn></mrow></mfrac><mo>≈</mo><mn>1.585</mn><mo>×</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>9</mn></mrow></msup></mrow><annotation encoding="application/x-tex">r_{\text{per second}} = \frac{0.05}{31\,536\,000} \approx 1.585 \times 10^{-9}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">per second</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">31</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">536</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.05</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1.585</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span></span></p><hr><h2 id="5-清算相关计算">5. 清算相关计算</h2><p>当借款人健康因子低于安全阈值时，清算者可以偿还部分债务并获得相应折扣的抵押品。清算奖励的计算公式为：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Collateral to Receive</mtext><mo>=</mo><mtext>Debt Covered</mtext><mo>×</mo><mfrac><mtext>Oracle Price of Debt Asset</mtext><mtext>Oracle Price of Collateral Asset</mtext></mfrac><mo>×</mo><mrow><mo fence="true">(</mo><mn>1</mn><mo>+</mo><mtext>Liquidation Bonus</mtext><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Collateral to Receive} = \text{Debt Covered} \times \frac{\text{Oracle Price of Debt Asset}}{\text{Oracle Price of Collateral Asset}} \times \left(1 + \text{Liquidation Bonus}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Collateral to Receive</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord text"><span class="mord">Debt Covered</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Oracle Price of Collateral Asset</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">Oracle Price of Debt Asset</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">Liquidation Bonus</span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></p><p><strong>示例</strong><br>假设：</p><ul><li>清算者偿还的债务金额（Debt Covered） = $10,000</li><li>借款资产的预言机价格 = $1/单位</li><li>抵押品的预言机价格 = $0.5/单位</li><li>清算奖励（Liquidation Bonus） = 5% (0.05)</li></ul><p>计算获得的抵押品数量：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Collateral to Receive</mtext><mo>=</mo><mn>10</mn><mtext> </mtext><mn>000</mn><mo>×</mo><mfrac><mn>1</mn><mn>0.5</mn></mfrac><mo>×</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mn>0.05</mn><mo stretchy="false">)</mo><mo>=</mo><mn>10</mn><mtext> </mtext><mn>000</mn><mo>×</mo><mn>2</mn><mo>×</mo><mn>1.05</mn><mo>=</mo><mn>21</mn><mtext> </mtext><mn>000</mn><mspace width="1em"><mtext>单位</mtext></mspace></mrow><annotation encoding="application/x-tex">\text{Collateral to Receive} = 10\,000 \times \frac{1}{0.5} \times (1 + 0.05) = 10\,000 \times 2 \times 1.05 = 21\,000 \quad \text{单位}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Collateral to Receive</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">10</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0.5</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0.05</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">10</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1.05</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">21</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">000</span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord cjk_fallback">单位</span></span></span></span></span></span></p><blockquote><p><strong>说明</strong>：在此示例中，清算者偿还 $10,000 的债务，可以获得价值 $10,500 的抵押品（如果每单位抵押品价值 $0.5，则数量为 21,000 个单位），实现额外的 5% 奖励。</p></blockquote><hr><h1>总结</h1><p>通过上述公式和示例，可以看出 Aave 协议如何利用精确的数学计算实现以下关键功能：</p><ul><li><strong>利率计算</strong>：根据储备利用率及预设参数分段计算可变与稳定借款利率，并进一步推导存款利率。</li><li><strong>利息累积</strong>：利用流动性指数与可变借款指数按时间累积利息，确保用户存款和借款状态实时更新。</li><li><strong>风险控制</strong>：通过健康因子监控借款人风险，当健康因子低于 1 时触发清算机制，保护系统安全。</li><li><strong>清算激励</strong>：在清算过程中，清算奖励机制确保清算者能以折扣价获得抵押品，从而激励市场行为保持整体系统健康。</li></ul><p>以上详细公式及具体数值示例为理解 Aave 借贷核心计算逻辑提供了直观参考。更多细节和实现代码请参考 <a href="https://github.com/aave/aave-v3-core/tree/master">Aave v3 Core GitHub 仓库</a> 中的源码及相关数学库（如 <a href="https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/libraries/math/WadRayMath.sol">WadRayMath.sol</a>）。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>使用 VS Code 开发 Salesforce 的完整指南</title>
    <link href="/2024/03/12/salesforce1/"/>
    <url>/2024/03/12/salesforce1/</url>
    
    <content type="html"><![CDATA[<p>方法 3：授予用户访问权限 在 Salesforce Setup（设置）搜索 Profiles找到 JWT 认证使用的 SalesforceUsername 所属的 Profile 在 Profile 设置中确保 "API Enabled" 选项已启用 在 "Connected App Access" 部分，勾选你的Connected App 保存 更改</p>]]></content>
    
    
    
    <tags>
      
      <tag>salesforce</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>uniswap</title>
    <link href="/2024/02/05/uniswap/"/>
    <url>/2024/02/05/uniswap/</url>
    
    <content type="html"><![CDATA[<p><img src="/2024/02/05/uniswap/2025-02-05-11-17-40.png"></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> copy <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;copy-to-clipboard&#x27;</span><br><span class="hljs-keyword">import</span> &#123; useCallback, useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCopyClipboard</span>(<span class="hljs-params">timeout = <span class="hljs-number">500</span></span>): [<span class="hljs-built_in">boolean</span>, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">toCopy</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>] &#123;<br>  <span class="hljs-keyword">const</span> [isCopied, setIsCopied] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>)<br><br>  <span class="hljs-keyword">const</span> staticCopy = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> didCopy = <span class="hljs-title function_">copy</span>(text)<br>    <span class="hljs-title function_">setIsCopied</span>(didCopy)<br>  &#125;, [])<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isCopied) &#123;<br>      <span class="hljs-keyword">const</span> hide = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">setIsCopied</span>(<span class="hljs-literal">false</span>)<br>      &#125;, timeout)<br><br>      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-built_in">clearTimeout</span>(hide)<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span><br>  &#125;, [isCopied, setIsCopied, timeout])<br><br>  <span class="hljs-keyword">return</span> [isCopied, staticCopy]<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ts"><span class="hljs-keyword">import</span> copy <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;copy-to-clipboard&#x27;</span><br><span class="hljs-keyword">import</span> &#123; useCallback, useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCopyClipboard</span>(<span class="hljs-params">timeout = <span class="hljs-number">500</span></span>): [<span class="hljs-built_in">boolean</span>, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">toCopy</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>] &#123;<br>  <span class="hljs-keyword">const</span> [isCopied, setIsCopied] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>)<br><br>  <span class="hljs-keyword">const</span> staticCopy = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> didCopy = <span class="hljs-title function_">copy</span>(text)<br>    <span class="hljs-title function_">setIsCopied</span>(didCopy)<br>  &#125;, [])<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isCopied) &#123;<br>      <span class="hljs-keyword">const</span> hide = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">setIsCopied</span>(<span class="hljs-literal">false</span>)<br>      &#125;, timeout)<br><br>      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-built_in">clearTimeout</span>(hide)<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span><br>  &#125;, [isCopied, setIsCopied, timeout])<br><br>  <span class="hljs-keyword">return</span> [isCopied, staticCopy]<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>web3</tag>
      
      <tag>defi</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dify base</title>
    <link href="/2024/02/05/dify-base/"/>
    <url>/2024/02/05/dify-base/</url>
    
    <content type="html"><![CDATA[<h1 id="models-erdiagram">models ERDiagram</h1><pre><code class=" mermaid">erDiagram    App &#123;        string id PK        string tenant_id FK        string name        string icon        string icon_background        string description        string mode        string status        boolean is_demo        boolean is_public        boolean is_pinned        string api_base_url        string api_key        string site_url        string copyright        string privacy_policy        string custom_disclaimer        string language        datetime created_at        datetime updated_at    &#125;        AppModelConfig &#123;        string id PK        string app_id FK        string opening_statement        string suggested_questions        string suggested_questions_after_answer        string speech_to_text        string text_to_speech        string more_like_this        string sensitive_word_avoidance        string external_data_tools        string model        string user_input_form        string dataset_query_variable        string pre_prompt        string agent_mode        string retriever_resource        string prompt_type        string chat_prompt_config        string completion_prompt_config        string dataset_configs        string file_upload    &#125;        RecommendedApp &#123;        string id PK        string app_id FK        json description        string copyright        string privacy_policy        string custom_disclaimer        string category        int position        boolean is_listed        int install_count        string language        datetime created_at        datetime updated_at    &#125;        InstalledApp &#123;        string id PK        string tenant_id FK        string app_id FK        string app_owner_tenant_id        int position        boolean is_pinned        datetime last_used_at        datetime created_at    &#125;        Conversation &#123;        string id PK        string app_id FK        string app_model_config_id FK        string model_provider        string override_model_configs        string model_id        string mode        string name        string summary        json inputs        string introduction        string system_instruction        int system_instruction_tokens        string status        string invoke_from        string from_source        string from_end_user_id FK        string from_account_id FK        datetime read_at        string read_account_id        int dialogue_count        datetime created_at        datetime updated_at        boolean is_deleted    &#125;        Message &#123;        string id PK        string app_id FK        string model_provider        string model_id        string override_model_configs        string conversation_id FK        json inputs        string query        json message        int message_tokens        decimal message_unit_price        decimal message_price_unit        string answer        int answer_tokens        decimal answer_unit_price        decimal answer_price_unit        string parent_message_id        float provider_response_latency        decimal total_price        string currency        string status        string error        string message_metadata        string invoke_from        string from_source        string from_end_user_id FK        string from_account_id FK        datetime created_at        datetime updated_at        boolean agent_based        string workflow_run_id FK    &#125;        MessageFeedback &#123;        string id PK        string app_id FK        string conversation_id FK        string message_id FK        string rating        string content        string from_source        string from_end_user_id FK        string from_account_id FK        datetime created_at        datetime updated_at    &#125;        MessageFile &#123;        string id PK        string message_id FK        string type        string transfer_method        string url        string belongs_to        string upload_file_id        string created_by_role        string created_by FK        datetime created_at    &#125;        MessageAnnotation &#123;        string id PK        string app_id FK        string conversation_id FK        string message_id FK        string question        string content        int hit_count        string account_id FK        datetime created_at        datetime updated_at    &#125;        App ||--o&#123; AppModelConfig : &quot;has&quot;    App ||--o&#123; RecommendedApp : &quot;is recommended as&quot;    App ||--o&#123; InstalledApp : &quot;is installed as&quot;    App ||--o&#123; Conversation : &quot;has&quot;    App ||--o&#123; Message : &quot;contains&quot;    App ||--o&#123; MessageFeedback : &quot;receives&quot;    App ||--o&#123; MessageAnnotation : &quot;has&quot;        AppModelConfig ||--o&#123; Conversation : &quot;configures&quot;        Conversation ||--o&#123; Message : &quot;contains&quot;    Conversation ||--o&#123; MessageAnnotation : &quot;has&quot;        Message ||--o&#123; MessageFeedback : &quot;receives&quot;    Message ||--o&#123; MessageFile : &quot;has&quot;    Message ||--o&#123; MessageAnnotation : &quot;has&quot;</code></pre><pre><code class=" mermaid">erDiagram    App &#123;        string id PK        string name        string description        string mode        boolean is_public        boolean is_demo        string status    &#125;        RecommendedApp &#123;        string id PK        string app_id FK        json description        string copyright        string privacy_policy        string category        int position        boolean is_listed        int install_count        string language    &#125;        Dataset &#123;        string id PK        string tenant_id FK        string name        string description        string provider        string permission        string data_source_type        string indexing_technique        string index_struct        string created_by FK        datetime created_at        string updated_by FK        datetime updated_at        string embedding_model        string embedding_model_provider        string collection_binding_id        json retrieval_model    &#125;        DatasetProcessRule &#123;        string id PK        string dataset_id FK        string mode        string rules        string created_by FK        datetime created_at    &#125;        Document &#123;        string id PK        string tenant_id FK        string dataset_id FK        int position        string data_source_type        string data_source_info        string dataset_process_rule_id FK        string batch        string name        string created_from        string created_by FK        datetime created_at        string indexing_status        boolean enabled        boolean archived        int word_count        int tokens        string doc_type        json doc_metadata        string doc_form        string doc_language    &#125;        DocumentSegment &#123;        string id PK        string tenant_id FK        string dataset_id FK        string document_id FK        int position        string content        string answer        int word_count        int tokens        string status        int hit_count        string index_node_id        string index_node_hash        boolean enabled        datetime created_at        datetime updated_at    &#125;        DatasetKeywordTable &#123;        string id PK        string dataset_id FK        string keyword        string created_by FK        datetime created_at    &#125;        AppDatasetJoin &#123;        string id PK        string app_id FK        string dataset_id FK        datetime created_at    &#125;        App ||--o&#123; RecommendedApp : &quot;is recommended as&quot;    App ||--o&#123; AppDatasetJoin : &quot;uses&quot;    Dataset ||--o&#123; AppDatasetJoin : &quot;is used by&quot;    Dataset ||--o&#123; Document : &quot;contains&quot;    Dataset ||--o&#123; DocumentSegment : &quot;has segments&quot;    Dataset ||--o&#123; DatasetProcessRule : &quot;has rules&quot;    Dataset ||--o&#123; DatasetKeywordTable : &quot;has keywords&quot;    Document ||--o&#123; DocumentSegment : &quot;is divided into&quot;</code></pre>]]></content>
    
    
    
    <tags>
      
      <tag>dify</tag>
      
      <tag>ai</tag>
      
      <tag>ai-agent</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
